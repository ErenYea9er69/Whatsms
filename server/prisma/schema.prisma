generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id          Int      @id @default(autoincrement())
  name        String
  phone       String   @unique
  preferences Json?    // Custom user-defined preferences
  interests   String[] // Array of interests e.g. ["marketing", "sales"]
  tags        String[] // Quick labels e.g. ["VIP", "Hot Lead"]
  
  lists       ContactListMember[]
  messages    CampaignRecipient[]
  flowExecutions FlowExecution[]
  conversations Conversation[]
  notes       ContactNote[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ContactList {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  
  members     ContactListMember[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ContactListMember {
  contactId     Int
  contactListId Int
  
  contact       Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactList   ContactList @relation(fields: [contactListId], references: [id], onDelete: Cascade)

  assignedAt    DateTime @default(now())

  @@id([contactId, contactListId])
}

model Campaign {
  id            Int      @id @default(autoincrement())
  name          String
  status        String   // DRAFT, SCHEDULED, IN_PROGRESS, COMPLETED, STOPPED
  scheduledAt   DateTime?
  messageBody   String
  
  recipients    CampaignRecipient[]
  attachments   CampaignAttachment[] // Many-to-many relationship with media
  
  statsDelivered Int @default(0)
  statsRead      Int @default(0)
  statsFailed    Int @default(0)
  statsReplied   Int @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model CampaignRecipient {
  id          Int      @id @default(autoincrement())
  campaignId  Int
  contactId   Int
  
  status      String   // PENDING, SENT, DELIVERED, READ, FAILED
  replied     Boolean  @default(false)
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  @@unique([campaignId, contactId])
}

model MessageTemplate {
  id        Int      @id @default(autoincrement())
  name      String
  content   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Media {
  id        Int      @id @default(autoincrement())
  filename  String
  path      String   // path in storage or URL
  mimetype  String
  size      Int
  
  campaigns CampaignAttachment[]
  
  createdAt DateTime @default(now())
}


model CampaignAttachment {
  campaignId Int
  mediaId    Int
  
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  media      Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  
  @@id([campaignId, mediaId])
}

model SystemConfig {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model Flow {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  isActive    Boolean  @default(false)
  triggerType String   // e.g., "KEYWORD", "NEW_CONTACT", "NO_REPLY"
  triggerKeyword String? // If triggerType is KEYWORD
  
  // The visual state of the flow (nodes, edges, viewport)
  content     Json
  
  executions  FlowExecution[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FlowExecution {
  id          Int      @id @default(autoincrement())
  flowId      Int
  contactId   Int
  status      String   // PENDING, IN_PROGRESS, COMPLETED, FAILED
  currentStep String?  // ID of the current node
  variables   Json?    // Store current state/variables for this execution
  
  flow        Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamMember {
  id            Int      @id @default(autoincrement())
  name          String
  email         String   @unique
  role          String   @default("AGENT") // ADMIN, AGENT, MANAGER
  avatar        String?
  
  conversations Conversation[]
  messages      ConversationMessage[]
  notes         ContactNote[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Conversation {
  id           Int      @id @default(autoincrement())
  contactId    Int
  
  assignedToId Int?
  status       String   @default("OPEN") // OPEN, CLOSED, PENDING
  lastMessage  String?
  lastMessageAt DateTime?
  unreadCount  Int      @default(0)
  
  contact      Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assignedTo   TeamMember? @relation(fields: [assignedToId], references: [id])
  
  messages     ConversationMessage[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ConversationMessage {
  id             Int      @id @default(autoincrement())
  conversationId Int
  
  content        String
  type           String   @default("TEXT") // TEXT, MEDIA, TEMPLATE
  direction      String   // INBOUND, OUTBOUND
  status         String   @default("SENT") // SENT, DELIVERED, READ, FAILED
  
  senderId       Int?     // If OUTBOUND, which TeamMember sent it?
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         TeamMember?  @relation(fields: [senderId], references: [id])
  
  createdAt      DateTime @default(now())
}

model ContactNote {
  id        Int      @id @default(autoincrement())
  contactId Int
  authorId  Int?
  
  content   String
  
  contact   Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  author    TeamMember? @relation(fields: [authorId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
